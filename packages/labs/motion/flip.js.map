{"version":3,"file":"flip.js","sources":["src/flip.ts"],"sourcesContent":["import {LitElement} from 'lit-element';\nimport {nothing, AttributePart} from 'lit-html';\nimport {directive, PartInfo, PartType} from 'lit-html/directive.js';\nimport {DisconnectableDirective} from 'lit-html/disconnectable-directive.js';\n\n// TODO(sorvell): Type better\nexport type CSSProperties = {\n  [index: string]: string | number;\n};\n\nexport type CSSPropertiesList = string[];\n\nexport type FlipOptions = {\n  onComplete?: (element: HTMLElement, flip: Flip) => void;\n  animationOptions?: KeyframeAnimationOptions;\n  properties?: CSSPropertiesList;\n  in?: Keyframe[];\n  out?: Keyframe[];\n  fromElement?: Element;\n  toElement?: Element;\n  stabilizeOut?: boolean;\n  guard?: () => unknown;\n};\n\nexport const flyBelow = [{transform: 'translateY(100%) scale(0)', opacity: 0}];\n\nexport const flyAbove = [{transform: 'translateY(-100%) scale(0)', opacity: 0}];\n\nexport const fadeOut = [{opacity: 0}];\nexport const fade = fadeOut;\n\nexport const fadeIn = [{opacity: 0}, {opacity: 1}];\n\nconst diffOp = (a: number, b: number) => {\n  const v = a - b;\n  return v === 0 ? undefined : v;\n};\nconst quotientOp = (a: number, b: number) => {\n  const v = a / b;\n  return v === 1 ? undefined : v;\n};\n\nconst transformProps = {\n  left: (a: number, b: number) => {\n    const v = diffOp(a, b);\n    return v && `translateX(${v}px)`;\n  },\n  top: (a: number, b: number) => {\n    const v = diffOp(a, b);\n    return v && `translateY(${v}px)`;\n  },\n  width: (a: number, b: number) => {\n    const v = quotientOp(a, b);\n    return v && `scaleX(${v})`;\n  },\n  height: (a: number, b: number) => {\n    const v = quotientOp(a, b);\n    return v && `scaleY(${v})`;\n  },\n};\n\nexport const defaultAnimationOptions: KeyframeAnimationOptions = {\n  duration: 333,\n  easing: `ease-in-out`,\n};\n\nexport const defaultCssProperties: CSSPropertiesList = [\n  'left',\n  'top',\n  'width',\n  'height',\n  'opacity',\n];\n\nconst isDirty = (value: unknown, previous: unknown) => {\n  if (value === undefined && previous === undefined) {\n    return true;\n  }\n  if (Array.isArray(value)) {\n    // Dirty-check arrays by item\n    if (\n      Array.isArray(previous) &&\n      previous.length === value.length &&\n      value.every((v, i) => v !== (previous as Array<unknown>)[i])\n    ) {\n      return true;\n    }\n  } else if (previous !== value) {\n    // Dirty-check non-arrays by identity\n    return true;\n  }\n  return false;\n};\n\nexport class Flip extends DisconnectableDirective {\n  private _host?: LitElement;\n  private _from!: CSSProperties;\n  private _to!: CSSProperties;\n  private _animatingElement!: HTMLElement;\n  private _parentNode: Element | null = null;\n  private _nextSibling: Node | null = null;\n  private _shouldAnimate = true;\n  private _previousValue: unknown;\n\n  reversing = false;\n  animation?: Animation;\n  options!: FlipOptions;\n\n  constructor(part: PartInfo) {\n    super(part);\n    if (part.type === PartType.CHILD) {\n      throw new Error(\n        'The `flip` directive must be used in attribute position.'\n      );\n    }\n  }\n\n  render(_options?: FlipOptions) {\n    return nothing;\n  }\n\n  update(part: AttributePart, [options]: Parameters<this['render']>) {\n    if (this._host === undefined) {\n      this._host = part.options?.host as LitElement;\n      this._host.addController(this);\n    }\n    this.options = options || {};\n    this.options.animationOptions ??= defaultAnimationOptions;\n    this.options.properties ??= defaultCssProperties;\n    this._animatingElement = part.element;\n    return this.render(options);\n  }\n\n  private _record(element: Element, props: CSSProperties) {\n    const bounds = element.getBoundingClientRect();\n    const computedStyle = getComputedStyle(element);\n    this.options.properties!.forEach((p) => {\n      const v =\n        bounds[p as keyof typeof bounds] ??\n        computedStyle[p as keyof CSSStyleDeclaration];\n      const asNum = Number(v);\n      props[p] = isNaN(asNum) ? String(v) : asNum;\n    });\n    // console.log('measuring', element, props);\n  }\n\n  getMeasuredElement() {\n    const el = this.reversing\n      ? this.options.fromElement\n      : this.options.toElement;\n    return el ?? this._animatingElement;\n  }\n\n  hostUpdate() {\n    const value = this.options.guard?.();\n    this._shouldAnimate =\n      !this._isAnimating() && isDirty(value, this._previousValue);\n    if (!this._shouldAnimate) {\n      // TODO(sorvell): what should this do?\n      //this.animation.cancel();\n      return;\n    }\n    // Copy the value if it's an array so that if it's mutated we don't forget\n    // what the previous values were.\n    if (value !== undefined) {\n      this._previousValue = Array.isArray(value) ? Array.from(value) : value;\n    }\n    //\n    const element = this.getMeasuredElement();\n    if (element.isConnected) {\n      this._record(element, (this._from = {}));\n    }\n    this._parentNode = this._animatingElement.parentNode as Element;\n    this._nextSibling = this._animatingElement.nextSibling;\n  }\n\n  hostUpdated() {\n    if (!this._shouldAnimate || !this._animatingElement.isConnected) {\n      return;\n    }\n    const element = this.getMeasuredElement();\n    this._record(element, (this._to = {}));\n    const frames =\n      this._from !== undefined\n        ? this._calculateFrames(this._from, this._to)\n        : this.options.in\n        ? [...this.options.in, {}]\n        : undefined;\n    console.log('animation frames', frames);\n    if (frames !== undefined) {\n      this._animate(frames);\n    }\n  }\n\n  reconnectedCallback() {}\n\n  // Experimental animate out functionality.\n  disconnectedCallback() {\n    if (!this._shouldAnimate) {\n      return;\n    }\n    requestAnimationFrame(async () => {\n      if (this._parentNode?.isConnected && this.options.out !== undefined) {\n        const ref =\n          this._nextSibling && this._nextSibling.parentNode === this._parentNode\n            ? this._nextSibling\n            : null;\n        this._parentNode.insertBefore(this._animatingElement, ref);\n        // Move to position before removal before animating\n        const shifted: CSSProperties = {};\n        this._record(this._animatingElement, shifted);\n        if (this.options.stabilizeOut) {\n          const left = diffOp(\n            this._from.left as number,\n            shifted.left as number\n          );\n          // TODO(sorvell): these nudges could conflict with existing styling\n          // or animation but setting left/top should be rare, especially via\n          // animation.\n          if (left !== 0) {\n            this._animatingElement.style.position = 'relative';\n            this._animatingElement.style.left = left + 'px';\n          }\n          const top = diffOp(this._from.top as number, shifted.top as number);\n          if (top !== 0) {\n            this._animatingElement.style.position = 'relative';\n            this._animatingElement.style.top = top + 'px';\n          }\n        }\n        await this._animate(this.options.out);\n        this._animatingElement.remove();\n      }\n    });\n  }\n\n  private _calculateFrames(from: CSSProperties, to: CSSProperties) {\n    const fromFrame: Keyframe = {};\n    const toFrame: Keyframe = {};\n    let hasFrames = false;\n\n    for (const p in to) {\n      const f = from[p],\n        t = to[p];\n      if (p in transformProps) {\n        const tp = transformProps[p as keyof typeof transformProps];\n        const v = tp(f as number, t as number);\n        if (v !== undefined) {\n          hasFrames = true;\n          fromFrame.transform = `${fromFrame.transform ?? ''} ${v}`;\n        }\n      } else if (f !== t) {\n        hasFrames = true;\n        fromFrame[p] = f;\n        toFrame[p] = t;\n      }\n    }\n    return hasFrames ? [fromFrame, toFrame] : undefined;\n  }\n\n  private _isAnimating() {\n    return this.animation?.playState === 'running';\n  }\n\n  private async _animate(frames: Keyframe[]) {\n    if (this._isAnimating()) {\n      return;\n    }\n    //console.log('animate', frames);\n    this.animation = this._animatingElement.animate(\n      frames,\n      this.options.animationOptions\n    );\n    await this.animation.finished;\n    this.options.onComplete?.(this._animatingElement, this);\n  }\n}\n\nexport const flip = directive(Flip);\n"],"names":["flyBelow","transform","opacity","flyAbove","fadeOut","fade","fadeIn","diffOp","a","b","v","undefined","quotientOp","transformProps","left","top","width","height","defaultAnimationOptions","duration","easing","defaultCssProperties","Flip","DisconnectableDirective","[object Object]","part","super","this","type","PartType","CHILD","Error","_options","nothing","options","_host","host","addController","animationOptions","properties","_animatingElement","element","render","props","bounds","getBoundingClientRect","computedStyle","getComputedStyle","forEach","p","asNum","Number","isNaN","String","reversing","fromElement","toElement","value","guard","_shouldAnimate","_isAnimating","previous","Array","isArray","length","every","i","isDirty","_previousValue","from","getMeasuredElement","isConnected","_record","_from","_parentNode","parentNode","_nextSibling","nextSibling","_to","frames","_calculateFrames","in","console","log","_animate","requestAnimationFrame","async","out","ref","insertBefore","shifted","stabilizeOut","style","position","remove","to","fromFrame","toFrame","hasFrames","f","t","tp","animation","playState","animate","finished","onComplete","flip","directive"],"mappings":"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"}